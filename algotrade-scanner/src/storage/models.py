"""
SQLAlchemy ORM Models

Purpose:
    Defines all database models for the system.
    Used by both PostgreSQL and TimescaleDB.

Dependencies:
    - SQLAlchemy

Logging:
    None (model definitions only)
"""

from datetime import datetime, timezone

from sqlalchemy import (
    Boolean,
    Column,
    DateTime,
    Float,
    ForeignKey,
    Index,
    Integer,
    String,
    Text,
    UniqueConstraint,
    BigInteger,
)
from sqlalchemy.orm import (
    DeclarativeBase,
    relationship,
)


class Base(DeclarativeBase):
    """Base class for all models."""
    pass


class Company(Base):
    """Company/stock master data."""

    __tablename__ = "companies"

    id = Column(Integer, primary_key=True, autoincrement=True)
    symbol = Column(String(20), unique=True, nullable=False, index=True)
    name = Column(String(200), nullable=False)
    isin = Column(String(12), unique=True, nullable=True)
    sector = Column(String(100), nullable=True)
    industry = Column(String(100), nullable=True)
    market_cap = Column(Float, nullable=True)
    listing_date = Column(DateTime, nullable=True)
    is_active = Column(Boolean, default=True)
    created_at = Column(
        DateTime, default=lambda: datetime.now(timezone.utc)
    )
    updated_at = Column(
        DateTime,
        default=lambda: datetime.now(timezone.utc),
        onupdate=lambda: datetime.now(timezone.utc),
    )

    # Relationships
    ohlcv_data = relationship("OHLCVData", back_populates="company")
    signals = relationship("Signal", back_populates="company")

    def __repr__(self) -> str:
        return f"<Company(symbol='{self.symbol}', name='{self.name}')>"


class OHLCVData(Base):
    """OHLCV price data (TimescaleDB hypertable)."""

    __tablename__ = "ohlcv_data"

    id = Column(BigInteger, primary_key=True, autoincrement=True)
    company_id = Column(
        Integer, ForeignKey("companies.id"), nullable=False
    )
    symbol = Column(String(20), nullable=False, index=True)
    date = Column(DateTime, nullable=False, index=True)
    open = Column(Float, nullable=False)
    high = Column(Float, nullable=False)
    low = Column(Float, nullable=False)
    close = Column(Float, nullable=False)
    volume = Column(BigInteger, nullable=False)
    delivery_volume = Column(BigInteger, nullable=True)
    delivery_percent = Column(Float, nullable=True)
    vwap = Column(Float, nullable=True)
    turnover = Column(Float, nullable=True)
    trades = Column(Integer, nullable=True)
    source = Column(String(50), nullable=True)
    created_at = Column(
        DateTime, default=lambda: datetime.now(timezone.utc)
    )

    # Relationships
    company = relationship("Company", back_populates="ohlcv_data")

    __table_args__ = (
        UniqueConstraint("symbol", "date", name="uq_ohlcv_symbol_date"),
        Index("idx_ohlcv_symbol_date", "symbol", "date"),
    )

    def __repr__(self) -> str:
        return (
            f"<OHLCVData(symbol='{self.symbol}', "
            f"date='{self.date}', close={self.close})>"
        )


class Signal(Base):
    """Trading signals generated by strategies."""

    __tablename__ = "signals"

    id = Column(Integer, primary_key=True, autoincrement=True)
    company_id = Column(
        Integer, ForeignKey("companies.id"), nullable=False
    )
    symbol = Column(String(20), nullable=False, index=True)
    strategy_name = Column(String(100), nullable=False, index=True)
    signal_type = Column(String(20), nullable=False)  # BUY, SELL, HOLD
    confidence = Column(Float, nullable=False)
    entry_price = Column(Float, nullable=True)
    target_price = Column(Float, nullable=True)
    stop_loss = Column(Float, nullable=True)
    indicators_met = Column(Integer, nullable=True)
    total_indicators = Column(Integer, nullable=True)
    metadata_json = Column(Text, nullable=True)  # JSON string
    generated_at = Column(
        DateTime, default=lambda: datetime.now(timezone.utc)
    )

    # Relationships
    company = relationship("Company", back_populates="signals")
    alerts = relationship("Alert", back_populates="signal")

    __table_args__ = (
        Index(
            "idx_signal_symbol_strategy",
            "symbol",
            "strategy_name",
            "generated_at",
        ),
    )

    def __repr__(self) -> str:
        return (
            f"<Signal(symbol='{self.symbol}', "
            f"strategy='{self.strategy_name}', "
            f"type='{self.signal_type}', "
            f"confidence={self.confidence})>"
        )


class Alert(Base):
    """Alert delivery log."""

    __tablename__ = "alerts"

    id = Column(Integer, primary_key=True, autoincrement=True)
    signal_id = Column(
        Integer, ForeignKey("signals.id"), nullable=False
    )
    channel = Column(String(50), nullable=False)  # telegram, email
    priority = Column(String(20), nullable=False)
    status = Column(String(20), nullable=False)  # sent, failed, queued
    message = Column(Text, nullable=True)
    retry_count = Column(Integer, default=0)
    error_message = Column(Text, nullable=True)
    sent_at = Column(DateTime, nullable=True)
    created_at = Column(
        DateTime, default=lambda: datetime.now(timezone.utc)
    )

    # Relationships
    signal = relationship("Signal", back_populates="alerts")

    def __repr__(self) -> str:
        return (
            f"<Alert(signal_id={self.signal_id}, "
            f"channel='{self.channel}', "
            f"status='{self.status}')>"
        )


class Order(Base):
    """Paper trading orders."""

    __tablename__ = "orders"

    id = Column(Integer, primary_key=True, autoincrement=True)
    symbol = Column(String(20), nullable=False, index=True)
    side = Column(String(10), nullable=False)  # BUY, SELL
    order_type = Column(String(20), nullable=False)  # MARKET, LIMIT
    quantity = Column(Integer, nullable=False)
    price = Column(Float, nullable=True)  # Limit price
    executed_price = Column(Float, nullable=True)
    executed_quantity = Column(Integer, nullable=True)
    status = Column(String(20), nullable=False)
    slippage = Column(Float, nullable=True)
    commission = Column(Float, nullable=True)
    signal_id = Column(Integer, ForeignKey("signals.id"), nullable=True)
    strategy_name = Column(String(100), nullable=True)
    created_at = Column(
        DateTime, default=lambda: datetime.now(timezone.utc)
    )
    executed_at = Column(DateTime, nullable=True)

    __table_args__ = (
        Index("idx_order_symbol_status", "symbol", "status"),
    )

    def __repr__(self) -> str:
        return (
            f"<Order(symbol='{self.symbol}', "
            f"side='{self.side}', "
            f"status='{self.status}')>"
        )


class Position(Base):
    """Paper trading positions."""

    __tablename__ = "positions"

    id = Column(Integer, primary_key=True, autoincrement=True)
    symbol = Column(String(20), nullable=False, index=True)
    side = Column(String(10), nullable=False)  # LONG, SHORT
    quantity = Column(Integer, nullable=False)
    avg_entry_price = Column(Float, nullable=False)
    current_price = Column(Float, nullable=True)
    unrealized_pnl = Column(Float, nullable=True)
    realized_pnl = Column(Float, default=0.0)
    stop_loss = Column(Float, nullable=True)
    target_price = Column(Float, nullable=True)
    strategy_name = Column(String(100), nullable=True)
    sector = Column(String(100), nullable=True)
    status = Column(String(20), nullable=False)  # OPEN, CLOSED
    opened_at = Column(
        DateTime, default=lambda: datetime.now(timezone.utc)
    )
    closed_at = Column(DateTime, nullable=True)

    def __repr__(self) -> str:
        return (
            f"<Position(symbol='{self.symbol}', "
            f"qty={self.quantity}, "
            f"status='{self.status}')>"
        )


class PerformanceMetric(Base):
    """Daily performance metrics snapshot."""

    __tablename__ = "performance_metrics"

    id = Column(Integer, primary_key=True, autoincrement=True)
    date = Column(DateTime, nullable=False, unique=True, index=True)
    portfolio_value = Column(Float, nullable=False)
    cash_balance = Column(Float, nullable=False)
    invested_value = Column(Float, nullable=False)
    daily_pnl = Column(Float, nullable=False)
    total_pnl = Column(Float, nullable=False)
    total_return_pct = Column(Float, nullable=False)
    sharpe_ratio = Column(Float, nullable=True)
    max_drawdown_pct = Column(Float, nullable=True)
    win_rate = Column(Float, nullable=True)
    total_trades = Column(Integer, default=0)
    winning_trades = Column(Integer, default=0)
    losing_trades = Column(Integer, default=0)
    active_positions = Column(Integer, default=0)
    created_at = Column(
        DateTime, default=lambda: datetime.now(timezone.utc)
    )

    def __repr__(self) -> str:
        return (
            f"<PerformanceMetric(date='{self.date}', "
            f"value={self.portfolio_value})>"
        )
